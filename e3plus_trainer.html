<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>E3+ Tränare</title>
<style>
body { margin:0; font-family:sans-serif; background:#0f1220; color:#e8ebff; }
.container { display:grid; grid-template-columns:360px 1fr; gap:18px; max-width:1100px; margin:20px auto; padding:16px; }
.panel { background: linear-gradient(180deg,#171a2b,#1f2340); border-radius:14px; padding:16px; border:1px solid #20264a; }
input { width:100px; padding:6px; border-radius:8px; background:#11152b; color:#e8ebff; border:1px solid #2a2f55; }
button { padding:10px 14px; border:none; border-radius:12px; cursor:pointer; font-weight:600; }
button.primary { background: linear-gradient(135deg,#6ea8fe,#7c9dff); color:#fff; }
button.ghost { background:transparent; border:1px solid #32407a; color:#e8ebff; }
.stimulus { display:grid; grid-template-columns:repeat(3,80px); grid-template-rows:repeat(3,80px); gap:8px; padding:8px; border-radius:12px; background:rgba(0,0,0,.2); }
.cell { width:80px; height:80px; display:flex; align-items:center; justify-content:center; font-size:42px; border-radius:10px; border:1px solid #2a2f55; background:#0b0f26; user-select:none; }
.actions { display:flex; gap:10px; margin-top:10px; }
.actions button { flex:1; }
.stats { margin-top:12px; display:grid; grid-template-columns:repeat(2,1fr); gap:8px; }
.stat { background:#101534; border:1px solid #262d5a; border-radius:12px; padding:8px; }
.stat .label { font-size:12px; color:#aeb5d6; }
.stat .value { font-family:monospace; font-size:16px; }
</style>
</head>
<body>
<div class="container">

<section class="panel controls">
<h2>Inställningar</h2>
<div><label>Testlängd (sek)</label><input id="duration" type="number" min="30" max="600" value="120"></div>
<div><label>Stimulus-tid (ms)</label><input id="trialTime" type="number" min="200" max="2000" value="900"></div>
<div><label>Paus/ISI (ms)</label><input id="isiTime" type="number" min="0" max="1500" value="200"></div>
<div><label>Mål-frekvens (%)</label><input id="targetRate" type="number" min="10" max="90" value="35"></div>
<div><label>Störprickar (0–5)</label><input id="noiseDots" type="number" min="0" max="5" value="2"></div>

<div style="margin-top:12px">
<button id="startBtn" class="primary">Starta testet</button>
<button id="stopBtn" class="ghost" disabled>Stoppa</button>
</div>

<div class="stats">
<div class="stat"><div class="label">Tid kvar</div><div id="timeLeft" class="value">–</div></div>
<div class="stat"><div class="label">Stimuli</div><div id="trials" class="value">0</div></div>
<div class="stat"><div class="label">Korrekt</div><div id="correct" class="value">0</div></div>
<div class="stat"><div class="label">Fel</div><div id="wrong" class="value">0</div></div>
<div class="stat"><div class="label">Missade</div><div id="missed" class="value">0</div></div>
<div class="stat"><div class="label">Poäng</div><div id="score" class="value">0</div></div>
<div class="stat"><div class="label">Träffsäkerhet</div><div id="accuracy" class="value">–</div></div>
</div>

</section>

<section class="panel">
<div id="stimulus" class="stimulus"></div>
<div class="actions">
<button id="yesBtn">JA (J)</button>
<button id="noBtn">NEJ (F)</button>
</div>
</section>

</div>

<script>
const el = {
  duration: document.getElementById('duration'),
  trialTime: document.getElementById('trialTime'),
  isiTime: document.getElementById('isiTime'),
  targetRate: document.getElementById('targetRate'),
  noiseDots: document.getElementById('noiseDots'),
  startBtn: document.getElementById('startBtn'),
  stopBtn: document.getElementById('stopBtn'),
  yesBtn: document.getElementById('yesBtn'),
  noBtn: document.getElementById('noBtn'),
  stimulus: document.getElementById('stimulus'),
  timeLeft: document.getElementById('timeLeft'),
  trials: document.getElementById('trials'),
  correct: document.getElementById('correct'),
  wrong: document.getElementById('wrong'),
  missed: document.getElementById('missed'),
  score: document.getElementById('score'),
  accuracy: document.getElementById('accuracy')
};

let state = {
  running:false,
  timerId:null,
  trialId:null,
  endTime:0,
  totals:{trials:0,correct:0,wrong:0,missed:0,score:0,rt:[],targets:0},
  current:{isTarget:false,responded:false,startTime:0}
};

const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
const randInt = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;
const sampleTarget = rate => Math.random()<rate/100;

function renderStimulus(isTarget, noiseDots){
  el.stimulus.innerHTML='';
  const grid=[];
  for(let i=0;i<9;i++){
    const cell=document.createElement('div');
    cell.className='cell';
    grid.push(cell);
    el.stimulus.appendChild(cell);
  }
  const neighbors=[0,1,2,3,5,6,7,8];
  grid.forEach(c=>c.textContent='');
  if(isTarget){
    grid[4].textContent='E';
    const dots=new Set();
    while(dots.size<3){ dots.add(neighbors[randInt(0,neighbors.length-1)]);}
    dots.forEach(i=>grid[i].textContent='•');
  } else {
    const letters='ABCDEFGHIKLMNOPQRSTUVWXYZ';
    let ch='E';
    while(ch==='E'){ ch=letters[randInt(0,letters.length-1)];}
    grid[4].textContent=ch;
    let k=randInt(0,5);
    const used=new Set();
    while(used.size<k){ used.add(neighbors[randInt(0,neighbors.length-1)]);}
    used.forEach(i=>grid[i].textContent='•');
  }
  let extra=clamp(parseInt(noiseDots||0,10),0,5);
  while(extra>0){
    const idx=randInt(0,8);
    if(grid[idx].textContent===''){ grid[idx].textContent='•'; extra--;}
  }
}

function isCurrentTarget(){
  const cells=[...el.stimulus.children];
  if(cells.length!==9) return false;
  if(cells[4].textContent!=='E') return false;
  const neighbors=[0,1,2,3,5,6,7,8];
  let dots=0;
  for(const i of neighbors){ if(cells[i].textContent==='•') dots++; }
  return dots===3;
}

function resetStats(){
  state.totals={trials:0,correct:0,wrong:0,missed:0,score:0,rt:[],targets:0};
  updateStats();
}

function updateStats(){
  const t=state.totals;
  const acc=(t.correct+t.wrong)?Math.round(100*t.correct/(t.correct+t.wrong)):'–';
  const rt=t.rt.length?t.rt.reduce((a,b)=>a+b,0)/t.rt.length:'–';
  el.trials.textContent=t.trials;
  el.correct.textContent=t.correct;
  el.wrong.textContent=t.wrong;
  el.missed.textContent=t.missed;
  el.score.textContent=t.score;
  el.accuracy.textContent=acc+'%';
}

function enableControls(enabled){
  el.duration.disabled=!enabled;
  el.trialTime.disabled=!enabled;
  el.isiTime.disabled=!enabled;
  el.targetRate.disabled=!enabled;
  el.noiseDots.disabled=!enabled;
  el.startBtn.disabled=!enabled;
  el.stopBtn.disabled=enabled;
}

function nextTrial(){
  if(!state.running) return;
  state.current.responded=false;
  state.current.isTarget=sampleTarget(parseInt(el.targetRate.value));
  renderStimulus(state.current.isTarget,parseInt(el.noiseDots.value));
  state.current.startTime=performance.now();
  state.totals.trials++;
  if(state.current.isTarget) state.totals.targets++;
  updateStats();
  const trialMs=clamp(parseInt(el.trialTime.value),100,5000);
  const isiMs=clamp(parseInt(el.isiTime.value),0,5000);
  state.trialId=setTimeout(()=>{
    if(!state.current.responded) state.totals.missed++;
    updateStats();
    el.stimulus.innerHTML='';
    if(Date.now()>=state.endTime){ stop(); return; }
    setTimeout(nextTrial,isiMs);
  },trialMs);
}

function start(){
  if(state.running) return;
  resetStats();
  state.running=true;
  enableControls(false);
  state.endTime=Date.now()+parseInt(el.duration.value)*1000;
  nextTrial();
  state.timerId=setInterval(()=>{
    const left=state.endTime-Date.now();
    el.timeLeft.textContent=Math.max(0,Math.floor(left/1000))+'s';
    if(left<=0) stop();
  },200);
}

function stop(){
  state.running=false;
  clearInterval(state.timerId);
  clearTimeout(state.trialId);
  enableControls(true);
  el.timeLeft.textContent='0s';
}

function handleResponse(yes){
  if(!state.running || state.current.responded) return;
  state.current.responded=true;
  const target=isCurrentTarget();
  const rt=Math.round(performance.now()-state.current.startTime);
  if((yes && target) || (!yes && !target)){ state.totals.correct++; state.totals.score++; state.totals.rt.push(rt);}
  else { state.totals.wrong++; state.totals.score--; }
  updateStats();
}

el.startBtn.addEventListener('click',start);
el.stopBtn.addEventListener('click',stop);
el.yesBtn.addEventListener('click',()=>handleResponse(true));
el.noBtn.addEventListener('click',()=>handleResponse(false));

window.addEventListener('keydown',e=>{
  if(e.repeat) return;
  const k=e.key.toLowerCase();
  if(k==='j') handleResponse(true);
  if(k==='f') handleResponse(false);
  if(k===' '){ e.preventDefault(); state.running?stop():start(); }
});

resetStats();
</script>
</body>
</html>


